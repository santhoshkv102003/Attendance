<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance - (CSE-III YEAR)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #6e7389 0%, #9349de 100%);
      min-height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 20px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 2.5em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(10, 90px);
      gap: 10px;
      margin: 20px auto;
      max-width: 1000px;
      justify-content: center;
    }
    .box {
      background: linear-gradient(145deg, #e8f5e8, #d4fcd4); /* gradient green = present */
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      user-select: none;
      transition: 0.3s;
      border: 2px solid #4caf50;
      font-size: 11px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 90px;
      width: 90px;
      line-height: 1.1;
      box-sizing: border-box;
      overflow: hidden;
      word-wrap: break-word;
      text-overflow: ellipsis;
    }
    .absent {
      background: linear-gradient(145deg, #ffebee, #ffd6d6);
      border: 2px solid #e04135;
      box-shadow: 0 4px 8px rgba(244, 67, 54, 0.2);
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .reset-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #ff4757;
      padding: 12px 22px;
      font-size: 18px;
      border-radius: 8px;
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      margin-top: 0;
    }
    .reset-btn:hover {
      background: #e0404e;
    }
    .history-btn {
      position: fixed;
      top: 10px;
      left: 120px;
      background: #28a745;
      padding: 12px 22px;
      font-size: 18px;
      border-radius: 8px;
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      margin-top: 0;
    }
    .history-btn:hover {
      background: #218838;
    }
    .save-btn {
      position: fixed;
      top: 10px;
      left: 230px;
      background: #ffc107;
      padding: 12px 22px;
      font-size: 18px;
      border-radius: 8px;
      color: #000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      margin-top: 0;
    }
    .save-btn:hover {
      background: #e0a800;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .history-day {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .history-day h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .history-absentees {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .history-absentees li {
      display: flex;
      justify-content: space-between;
      padding: 5px 10px;
      margin: 5px 0;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .no-data {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }
    .clear-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 10px 0;
      float: right;
      position: sticky;
      bottom: 0;
    }
    .clear-btn:hover {
      background: #c82333;
    }
  </style>
</head>
<body>

  <button class="reset-btn" onclick="resetPage()">Reset</button>
  <button class="history-btn" onclick="showHistory()">History</button>
  <button class="save-btn" onclick="saveDailyAttendance()">Save Today</button>
  <h1>Attendance - (CSE-III YEAR)</h1>
  <div style="display: flex; justify-content: space-between; align-items: flex-start; max-width: 1200px; margin: 0 auto; gap: 20px;">
    <div>
      <div class="grid" id="grid"></div>
      <div class="grid" id="remainingGrid" style="margin-top: 10px;"></div>
    </div>
    <div style="text-align: center; min-width: 300px; margin-left: 20px; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <div id="result"></div>
    </div>
  </div>

  <script>
    // 69 names
    const names = [
      "AAKASH M", "AARTHIKA P", "AATHISANKAR A", "AISHWARYA R", "AJAYKUMAR KAVITHAMANI RAMANI",
      "ANCY SNEHA P", "ANGEL V", "ASWINI S", "AYNHARAN S", "CHIDAMBARAM N",
      "DEVA SRI D", "DEVADHARSAN B", "DHANUSH P", "DHANUSH RAAGAV S", "DHARSINI R",
      "DHAVAMANI A", "DHILEEPAN T", "DHINAHAR M", "DIVYASRI M", "GLADWIN LEVIS J",
      "HEMA DHARSHANA S J", "JOSEPH RAJA G", "KABILESH K", "KIRUTHIKA P", "LOKESH R",
      "MADHU MITHRA A", "MADHURA A", "MAGESH S", "MITHUL V", "MOHAMMED IBRAHIM R",
      "MOHANARIPRASATH J", "MUHAMMED HASSAN S", "MURUGAVEL N", "NANDHINI R", "NANDHINI V",
      "NITHISH R", "NIVETHIKA P", "PADMADEV D", "PAVITHRA M", "PRADEEP SA",
      "PRANEESH P", "PRIYADHARSHINI M", "RAJAGANAPATHI M", "RITHIKA S", "K. RITHIKAA",
      "A ROSHINI KRITHI", "SANJAYTHARAN S", "SANTHOSH K V", "SANTHOSH KUMAR R", "SATHIYASEELAN S",
      "SELVA VIKASH P", "SEVANI P P", "SHASHANK M TAREEHAL", "SIBY R", "SIRANJEEVI E",
      "SIVAGAMI R", "SRIMATHI K", "SUGANYA S", "TULASIRAM V", "S. VARSHITHA",
      "VIGNESH S", "VIGNESHWARAN M", "KIRUBA SANKARI J", "MURALI PRASANTH C", "NAVIN ANTO SUDHARSON K",
      "PRASHANNA LAKSHMI S", "RITHANYA R", "SANDEEP KUMAR J", "DHARINEESH S"
    ];

    const STATE_KEY = 'attendance_absent_v1';
    const HISTORY_KEY = 'attendance_history_v1';

    // Special numbering overrides for bottom row
    const specialNumberByName = {
      "TULASIRAM V": 60,
      "S. VARSHITHA": 61,
      "VIGNESH S": 62,
      "VIGNESHWARAN M": 63,
      "KIRUBA SANKARI J": 301,
      "MURALI PRASANTH C": 302,
      "NAVIN ANTO SUDHARSON K": 303,
      "PRASHANNA LAKSHMI S": 304,
      "RITHANYA R": 305,
      "SANDEEP KUMAR J": 306,
      "DHARINEESH S": 70
    };

    function getNumberForIndex(i) {
      const name = names[i];
      if (name in specialNumberByName) return specialNumberByName[name];
      if (i < 60) return i + 1; // default 1-60
      if (i < 63) return i + 1; // 61-63 fallback if not in map
      return 301 + (i - 63);
    }

    const grid = document.getElementById("grid");
    const remainingGrid = document.getElementById("remainingGrid");

    // History management functions
    function saveDailyAttendance() {
      const today = new Date().toDateString();
      const boxes = document.querySelectorAll('.box');
      const absentIndices = [];
      boxes.forEach((box, i) => {
        if (box.classList.contains('absent')) absentIndices.push(i);
      });
      
      const absentees = absentIndices.map(i => ({
        name: names[i], 
        number: getNumberForIndex(i)
      }));

      let history = [];
      try { 
        history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); 
      } catch (_) { 
        history = []; 
      }

      // Remove any existing entry for today
      history = history.filter(entry => entry.date !== today);
      
      // Add today's data with timestamp
      history.push({
        date: today,
        absentees: absentees,
        totalAbsent: absentees.length,
        savedAt: new Date().toISOString()
      });

      // Keep only last 10 days
      history = history.slice(-10);

      try { 
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); 
        // Show confirmation
        alert(`Today's attendance saved! ${absentees.length} absentees recorded.`);
      } catch (_) {
        alert('Error saving attendance data.');
      }
    }

    function loadHistory() {
      let history = [];
      try { 
        history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); 
      } catch (_) { 
        history = []; 
      }
      return history;
    }

    function showHistory() {
      const history = loadHistory();
      const modal = document.getElementById('historyModal');
      const content = document.getElementById('historyContent');

      if (history.length === 0) {
        content.innerHTML = '<div class="no-data">No attendance history available yet.</div>';
      } else {
        let html = '';
        history.reverse().forEach(day => {
          const savedAtDisplay = day.savedAt ? new Date(day.savedAt).toLocaleString() : day.date;
          html += `<div class="history-day">`;
          html += `<h3>${savedAtDisplay} - ${day.totalAbsent} Absentees</h3>`;
          if (day.absentees.length > 0) {
            html += '<ul class="history-absentees">';
            day.absentees.forEach(student => {
              html += `<li><span>${student.name}</span><span>(${student.number})</span></li>`;
            });
            html += '</ul>';
          } else {
            html += '<p style="color: green; font-weight: bold;">All students were present!</p>';
          }
          html += '</div>';
        });
        html += '<button class="clear-btn" onclick="clearHistory()">Clear All History</button>';
        content.innerHTML = html;
      }

      modal.style.display = 'block';
    }

    function closeHistory() {
      document.getElementById('historyModal').style.display = 'none';
    }

    function clearHistory() {
      if (confirm('Are you sure you want to clear all attendance history? This action cannot be undone.')) {
        try {
          localStorage.removeItem(HISTORY_KEY);
          alert('All attendance history has been cleared successfully!');
          closeHistory();
        } catch (_) {
          alert('Error clearing history data.');
        }
      }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('historyModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    function saveState() {
      const boxes = document.querySelectorAll('.box');
      const absentIndices = [];
      boxes.forEach((box, i) => {
        if (box.classList.contains('absent')) absentIndices.push(i);
      });
      try { localStorage.setItem(STATE_KEY, JSON.stringify(absentIndices)); } catch (_) {}
      // Note: Daily history is only saved when "Save Today" button is clicked
    }

    function loadState() {
      let stored;
      try { stored = JSON.parse(localStorage.getItem(STATE_KEY) || '[]'); } catch (_) { stored = []; }
      const boxes = document.querySelectorAll('.box');
      stored.forEach(i => {
        if (boxes[i]) boxes[i].classList.add('absent');
      });
    }

    // Create boxes for first 60 students (10x6 grid)
    for (let i = 0; i < 60; i++) {
      const div = document.createElement("div");
      div.className = "box"; // default: present
      div.innerHTML = `<div>${names[i]}</div><div>(${getNumberForIndex(i)})</div>`;
      div.onclick = () => {
        div.classList.toggle("absent"); // toggle between present and absent
        saveState();
        updateAbsentees(); // automatically update absentees list
      };
      grid.appendChild(div);
    }

    // Create boxes for remaining 9 students with special numbering
    for (let i = 60; i < 69; i++) {
      const div = document.createElement("div");
      div.className = "box"; // default: present
      div.innerHTML = `<div>${names[i]}</div><div>(${getNumberForIndex(i)})</div>`;
      div.onclick = () => {
        div.classList.toggle("absent"); // toggle between present and absent
        saveState();
        updateAbsentees(); // automatically update absentees list
      };
      remainingGrid.appendChild(div);
    }

    function updateAbsentees() {
      const boxes = document.querySelectorAll(".box");
      const absentees = [];
      boxes.forEach((box, i) => {
        if (box.classList.contains("absent")) {
          absentees.push({name: names[i], number: getNumberForIndex(i)});
        }
      });

      let html = `<h2>Total Absentees: ${absentees.length}</h2>`;
      if (absentees.length > 0) {
        html += "<ul style='text-align: left; padding-left: 20px; list-style: none;'>";
        absentees.forEach(student => {
          html += `<li style='display: flex; justify-content: space-between; margin-bottom: 5px; padding: 5px; background: #f8f9fa; border-radius: 4px;'><span>${student.name}</span><span style='color: #666; font-weight: bold;'>(${student.number})</span></li>`;
        });
        html += "</ul>";
      } else {
        html += "<p style='color: green; font-weight: bold;'>All students are present!</p>";
      }

      document.getElementById("result").innerHTML = html;
    }

    function resetPage() {
      try { localStorage.removeItem(STATE_KEY); } catch (_) {}
      window.location.reload();
    }

    // Initialize the absentees display from saved state
    loadState();
    updateAbsentees();
  </script>

  <!-- History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeHistory()">&times;</span>
      <h2>Past 10 Days Absentees History</h2>
      <div id="historyContent"></div>
    </div>
  </div>

</body>
</html>
